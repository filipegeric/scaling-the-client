<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />

    <title>Scaling the client</title>

    <link rel="stylesheet" href="dist/reset.css" />
    <link rel="stylesheet" href="dist/reveal.css" />
    <link rel="stylesheet" href="dist/theme/night.css" />
    <link rel="stylesheet" href="styles.css" />

    <!-- Theme used for syntax highlighted code -->
    <link rel="stylesheet" href="plugin/highlight/monokai.css" />

    <style>
      .box {
        border: solid 2px var(--r-main-color);
      }
    </style>
  </head>
  <body class="doodle">
    <div class="reveal">
      <div class="slides">
        <section style="height: 100%">
          <div
            style="
              height: 100%;
              display: flex;
              flex-direction: column;
              justify-content: center;
            "
          >
            <h2>Scaling the Client</h2>
            <h4>by Filip EgeriÄ‡</h4>
          </div>
        </section>
        <section>
          <h3>What is Client?</h3>
          <div class="r-stack">
            <img
              class="fragment fade-in-then-out"
              src="images/client-server.svg"
            />
            <img
              class="fragment fade-in-then-out"
              src="images/common-clients.svg"
            />
          </div>
        </section>
        <section>
          <h3>What is Scaling?</h3>
          <p class="fragment fade-in">
            Exercising an application's ability to handle workload variation
            while adding or removing users with minimal costs.
          </p>
          <h3 class="fragment fade-in">Why is it done?</h3>
          <p class="fragment fade-in">
            To be able to process more requests without noticeable performance
            decrease (<b>scaling up</b>) or to reduce costs (<b>scaling down</b
            >).
          </p>
        </section>
        <section style="height: 100%">
          <h3>Horizontal vs vertical scaling</h3>
          <div class="demo">
            <form class="demo-controls">
              <select>
                <option value="vertical">Vertical</option>
                <option value="horizontal">Horizontal</option>
              </select>
              <input type="number" value="2" placeholder="Number of users" />
              <button id="start-demo">Send requests</button>
            </form>
            <div class="users">
              <svg
                class="user"
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  fill-rule="evenodd"
                  clip-rule="evenodd"
                  d="M18.5 20H5.5C4.67 20 4 19.33 4 18.5C4 15.63 6.22 13.26 9.04 13.02C9.87 13.64 10.89 14 12 14C13.11 14 14.13 13.64 14.96 13.02C17.78 13.26 20 15.63 20 18.5C20 19.33 19.33 20 18.5 20ZM8 9C8 6.79 9.79 5 12 5C14.21 5 16 6.79 16 9C16 10.2 15.47 11.28 14.63 12.01C13.92 12.63 13 13 12 13C11 13 10.08 12.63 9.37 12.01C8.53 11.28 8 10.2 8 9ZM15.88 12.15C16.58 11.29 17 10.19 17 9C17 6.24 14.76 4 12 4C9.24 4 7 6.24 7 9C7 10.19 7.42 11.29 8.12 12.15C5.19 12.78 3 15.38 3 18.5C3 19.88 4.12 21 5.5 21H18.5C19.88 21 21 19.88 21 18.5C21 15.38 18.81 12.78 15.88 12.15Z"
                  fill="currentColor"
                />
              </svg>
              <svg
                class="user"
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  fill-rule="evenodd"
                  clip-rule="evenodd"
                  d="M18.5 20H5.5C4.67 20 4 19.33 4 18.5C4 15.63 6.22 13.26 9.04 13.02C9.87 13.64 10.89 14 12 14C13.11 14 14.13 13.64 14.96 13.02C17.78 13.26 20 15.63 20 18.5C20 19.33 19.33 20 18.5 20ZM8 9C8 6.79 9.79 5 12 5C14.21 5 16 6.79 16 9C16 10.2 15.47 11.28 14.63 12.01C13.92 12.63 13 13 12 13C11 13 10.08 12.63 9.37 12.01C8.53 11.28 8 10.2 8 9ZM15.88 12.15C16.58 11.29 17 10.19 17 9C17 6.24 14.76 4 12 4C9.24 4 7 6.24 7 9C7 10.19 7.42 11.29 8.12 12.15C5.19 12.78 3 15.38 3 18.5C3 19.88 4.12 21 5.5 21H18.5C19.88 21 21 19.88 21 18.5C21 15.38 18.81 12.78 15.88 12.15Z"
                  fill="currentColor"
                />
              </svg>
            </div>
            <div class="load-balancer">
              <p>Load Balancer</p>
            </div>
            <div class="servers">
              <div class="server"><p>Server</p></div>
            </div>
          </div>
        </section>
        <section>
          <h3>How to scale a client?</h3>
          <ul>
            <li class="fragment">
              Reduce number of requests sent to the server - Caching
            </li>
            <li class="fragment">Let the client do the heavy lifting</li>
          </ul>
        </section>
        <section>
          <h3>Story #1 - Gym photos</h3>
          <div class="r-stack">
            <img
              class="fragment fade-in-then-out"
              src="images/gym-app.svg"
              style="height: 100%"
            />
            <img
              class="fragment fade-in-then-out"
              src="images/gym-app-initial-setup.svg"
              style="height: 100%"
            />
            <img
              class="fragment fade-in-then-out"
              src="images/gym-app-with-object-storage.svg"
              style="height: 100%"
            />
          </div>
        </section>
        <section>
          <h3>Uploading images</h3>
          <div class="r-stack">
            <img src="images/gym-app-upload-0.svg" class="fragment" />
            <img src="images/gym-app-upload-1.svg" class="fragment" />
            <img src="images/gym-app-upload-2.svg" class="fragment" />
            <img src="images/gym-app-upload-3.svg" class="fragment" />
            <img src="images/gym-app-upload-4.svg" class="fragment" />
          </div>
        </section>
        <section>
          <h3>Uploading images (revised)</h3>
          <div class="r-stack">
            <img src="images/gym-app-upload-0-revised.svg" class="fragment" />
            <img src="images/gym-app-upload-1-revised.svg" class="fragment" />
            <img src="images/gym-app-upload-2-revised.svg" class="fragment" />
            <img src="images/gym-app-upload-3-revised.svg" class="fragment" />
            <img src="images/gym-app-upload-4-revised.svg" class="fragment" />
            <img src="images/gym-app-upload-5-revised.svg" class="fragment" />
            <img src="images/gym-app-upload-6-revised.svg" class="fragment" />
          </div>
        </section>
        <section>
          <h3>But what about thumbnails?</h3>
          <div class="r-stack">
            <img
              class="fragment fade-in-then-out"
              src="images/gym-app.svg"
              style="height: 100%"
            />
            <img
              class="fragment fade-in-then-out"
              src="images/gym-app-upload-thumbnail-worker.svg"
            />
            <img
              src="images/gym-app-upload-6-revised.svg"
              class="fragment fade-in-then-out"
            />
            <img
              src="images/gym-app-upload-6-revised-with-thumbnail.svg"
              class="fragment"
            />
          </div>
        </section>
        <section>
          <h3>Generate thumbnail - demo</h3>
          <div class="generate-thumbnail-demo">
            <input id="generate-thumbnail-file-input" type="file" />
            <div class="stats">
              <p>File size: <span id="file-size">0</span></p>
              <p>Thumbnail size: <span id="thumbnail-size">0</span></p>
              <p>Time taken: <span id="time-taken">0</span> ms</p>
            </div>
          </div>
          <div class="preview"></div>
        </section>
        <section>
          <h3>Story #2 - So many open tabs</h3>
          <img
            class="fragment fade-in"
            src="images/grafana-screenshot.png"
            alt=""
          />
        </section>
        <section>
          <h3>What are WebSockets?</h3>
          <p class="fragment">
            A communication protocol that provides full-duplex communication
            channels over a single TCP connection.
          </p>
          <div class="r-stack">
            <img class="fragment" src="images/websocket-basic-0.svg" alt="" />
            <img class="fragment" src="images/websocket-basic-1.svg" alt="" />
            <img class="fragment" src="images/websocket-basic-2.svg" alt="" />
            <img class="fragment" src="images/websocket-basic-3.svg" alt="" />
            <img class="fragment" src="images/websocket-basic-4.svg" alt="" />
            <img class="fragment" src="images/websocket-basic-5.svg" alt="" />
          </div>
        </section>
        <section>
          <h3>What about scaling?</h3>
          <div class="r-stack">
            <img src="images/websocket-scaling-0.svg" alt="" class="fragment" />
            <img src="images/websocket-scaling-1.svg" alt="" class="fragment" />
            <img src="images/websocket-scaling-2.svg" alt="" class="fragment" />
            <img src="images/websocket-scaling-3.svg" alt="" class="fragment" />
            <img src="images/websocket-scaling-4.svg" alt="" class="fragment" />
            <img src="images/websocket-scaling-5.svg" alt="" class="fragment" />
            <img src="images/websocket-scaling-6.svg" alt="" class="fragment" />
          </div>
        </section>
        <section>
          <h3>What about scaling?</h3>
          <div class="r-stack">
            <img
              src="images/websocket-scaling-pubsub-0.svg"
              alt=""
              class="fragment"
            />
            <img
              src="images/websocket-scaling-pubsub-1.svg"
              alt=""
              class="fragment"
            />
            <img
              src="images/websocket-scaling-pubsub-2.svg"
              alt=""
              class="fragment"
            />
            <img
              src="images/websocket-scaling-pubsub-3.svg"
              alt=""
              class="fragment"
            />
            <img
              src="images/websocket-scaling-pubsub-4.svg"
              alt=""
              class="fragment"
            />
            <img
              src="images/websocket-scaling-pubsub-5.svg"
              alt=""
              class="fragment"
            />
          </div>
        </section>
      </div>
    </div>

    <!-- Scaling demo -->
    <script>
      document
        .querySelector(".demo-controls")
        .addEventListener("submit", (e) => {
          e.preventDefault();
          const numberOfUsers = Number(document.querySelector("input").value);
          const userTemplate = document.querySelector(".user");
          const users = document.querySelector(".users");
          users.innerHTML = "";
          for (let i = 0; i < numberOfUsers; i++) {
            users.appendChild(userTemplate.cloneNode(true));
          }
          const isVertical =
            document.querySelector("select").value === "vertical";
          const numberOfServers = isVertical ? 1 : numberOfUsers / 3;
          const serverTemplate = document.querySelector(".server");
          serverTemplate.style.transform = "none";
          const servers = document.querySelector(".servers");
          servers.innerHTML = "";
          for (let i = 0; i < numberOfServers; i++) {
            servers.appendChild(serverTemplate.cloneNode(true));
          }
          document.querySelector(".server").style.transform = isVertical
            ? `scaleX(${Math.max(1, Math.ceil(numberOfUsers / 3))})`
            : "none";

          startSimulation();
        });

      function startSimulation() {
        const users = document.querySelectorAll(".user");
        const loadBalancer = document.querySelector(".load-balancer");
        const servers = document.querySelectorAll(".server");

        for (const user of users) {
          setTimeout(() => {
            sendRequest(user, loadBalancer, servers);
          }, Math.random() * 750);
        }
      }

      async function sendRequest(user, loadBalancer, servers) {
        const requestBall = createRequestBall(user);
        document.documentElement.appendChild(requestBall);

        await sendRequestFromTo(requestBall, loadBalancer);
        await sendRequestFromTo(requestBall, servers);
        requestBall.remove();
      }

      function createRequestBall(user) {
        const requestBall = document.createElement("div");
        requestBall.classList.add("request-ball");
        requestBall.style.backgroundColor =
          "#" + Math.floor(Math.random() * 16777215).toString(16);
        requestBall.style.top = `${user.getBoundingClientRect().top}px`;
        requestBall.style.left = `${user.getBoundingClientRect().left}px`;
        return requestBall;
      }

      function sendRequestFromTo(requestBall, targetOrTargets) {
        return new Promise((resolve) => {
          const target =
            targetOrTargets instanceof NodeList
              ? targetOrTargets.item(
                  Math.floor(Math.random() * targetOrTargets.length)
                )
              : targetOrTargets;
          const targetRect = target.getBoundingClientRect();
          const targetCenterY = (targetRect.top + targetRect.bottom) / 2;
          const targetCenterX = (targetRect.left + targetRect.right) / 2;
          requestAnimationFrame(() => {
            requestBall.style.top = `${targetCenterY - 12}px`;
            requestBall.style.left = `${targetCenterX - 12}px`;
          });
          setTimeout(() => {
            resolve();
          }, 500);
        });
      }
    </script>

    <!-- Generate thumbnail demo -->
    <script>
      document
        .querySelector("#generate-thumbnail-file-input")
        .addEventListener("change", async (e) => {
          const file = e.target.files[0];
          const fileSize = file.size;
          const fileSizeInMb = (fileSize / 1024 / 1024).toFixed(2);
          document.querySelector(
            "#file-size"
          ).textContent = `${fileSizeInMb} MB`;
          const start = performance.now();
          const thumbnail = await generateThumbnail(file);
          const thumbnailImage = new Image();
          thumbnailImage.src = URL.createObjectURL(thumbnail);
          document.querySelector(".preview").appendChild(thumbnailImage);
          const end = performance.now();
          const thumbnailSizeKb = (thumbnail.size / 1024).toFixed(2);
          document.querySelector(
            "#thumbnail-size"
          ).textContent = `${thumbnailSizeKb} KB`;
          document.querySelector("#time-taken").textContent = Math.round(
            end - start
          );
        });

      /**
       * @returns {Promise<Blob>}
       * */
      async function generateThumbnail(file) {
        const canvas = document.createElement("canvas");
        const ctx = canvas.getContext("2d");
        const image = await loadImage(file);
        canvas.width = 100;
        canvas.height = (100 / image.width) * image.height;
        document.querySelector(".preview").appendChild(image);
        ctx.drawImage(image, 0, 0, canvas.width, canvas.height);
        return new Promise((resolve) => {
          canvas.toBlob((blob) => {
            resolve(blob);
          });
        });
      }

      function loadImage(file) {
        return new Promise((resolve) => {
          const reader = new FileReader();
          reader.onload = (e) => {
            const image = new Image();
            image.onload = () => {
              resolve(image);
            };
            image.src = e.target.result;
          };
          reader.readAsDataURL(file);
        });
      }
    </script>

    <script src="dist/reveal.js"></script>
    <script src="plugin/notes/notes.js"></script>
    <script src="plugin/markdown/markdown.js"></script>
    <script src="plugin/highlight/highlight.js"></script>
    <script>
      // More info about initialization & config:
      // - https://revealjs.com/initialization/
      // - https://revealjs.com/config/
      Reveal.initialize({
        hash: true,
        center: false,
        // Learn about plugins: https://revealjs.com/plugins/
        plugins: [RevealMarkdown, RevealHighlight, RevealNotes],
      });
    </script>
  </body>
</html>
